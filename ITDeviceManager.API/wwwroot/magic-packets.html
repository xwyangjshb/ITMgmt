<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魔术包监听 - IT设备管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        .status-indicator.active {
            background-color: #28a745;
        }
        .status-indicator.inactive {
            background-color: #dc3545;
            animation: none;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .new-record {
            animation: highlight 2s;
        }
        @keyframes highlight {
            0% { background-color: #fff3cd; }
            100% { background-color: transparent; }
        }
        .stat-card {
            border-left: 4px solid #0d6efd;
        }
        .valid-badge {
            background-color: #28a745;
        }
        .invalid-badge {
            background-color: #dc3545;
        }
        .matched-badge {
            background-color: #17a2b8;
        }
        .no-data {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/index.html">IT设备管理系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/index.html">设备管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/magic-packets.html">魔术包监听</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logs.html">日志查看</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col">
                <h2>
                    <i class="bi bi-wifi"></i> 魔术包监听
                    <span class="status-indicator active" id="statusIndicator"></span>
                    <small class="text-muted" id="statusText">监听中...</small>
                </h2>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">总捕获数</h6>
                        <h3 class="card-title mb-0" id="totalCaptures">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">今天捕获</h6>
                        <h3 class="card-title mb-0" id="todayCaptures">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">有效包</h6>
                        <h3 class="card-title mb-0" id="validCaptures">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">已匹配设备</h6>
                        <h3 class="card-title mb-0" id="matchedCaptures">-</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- 最后捕获信息 -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">最后捕获</h6>
                        <div id="lastCaptureInfo">暂无捕获记录</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 控制按钮 -->
        <div class="row mb-3">
            <div class="col">
                <button class="btn btn-primary" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i> 刷新
                </button>
                <button class="btn btn-secondary" onclick="toggleAutoRefresh()">
                    <i class="bi bi-play-fill" id="autoRefreshIcon"></i>
                    <span id="autoRefreshText">启用自动刷新</span>
                </button>
                <span class="ms-2 text-muted" id="lastRefreshTime"></span>
            </div>
        </div>

        <!-- 捕获记录表格 -->
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">捕获记录</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>捕获时间</th>
                                        <th>目标MAC地址</th>
                                        <th>来源IP</th>
                                        <th>匹配设备</th>
                                        <th>包大小</th>
                                        <th>状态</th>
                                        <th>备注</th>
                                    </tr>
                                </thead>
                                <tbody id="capturesTableBody">
                                    <tr>
                                        <td colspan="7" class="no-data">
                                            <i class="bi bi-hourglass-split" style="font-size: 3rem;"></i>
                                            <p class="mt-2">加载中...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分页 -->
        <div class="row mt-3">
            <div class="col">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center" id="pagination">
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let autoRefreshEnabled = false;
        let autoRefreshInterval = null;
        let currentPage = 1;
        let lastCapturedAt = null;
        const pageSize = 50;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadCaptures();
        });

        // 加载统计信息
        async function loadStats() {
            try {
                const response = await fetch('/api/MagicPackets/stats');
                if (!response.ok) throw new Error('Failed to load stats');

                const data = await response.json();

                console.log('Stats API response:', data); // 调试信息

                document.getElementById('totalCaptures').textContent = data.totalCaptures || 0;
                document.getElementById('todayCaptures').textContent = data.todayCaptures || 0;
                document.getElementById('validCaptures').textContent = data.validCaptures || 0;
                document.getElementById('matchedCaptures').textContent = data.matchedCaptures || 0;

                if (data.lastCapture) {
                    const capturedAt = new Date(data.lastCapture.capturedAt);
                    const timeAgo = getTimeAgo(capturedAt);
                    const deviceInfo = data.lastCapture.matchedDeviceName
                        ? `<span class="badge matched-badge">${data.lastCapture.matchedDeviceName}</span>`
                        : '<span class="badge bg-secondary">未知设备</span>';

                    document.getElementById('lastCaptureInfo').innerHTML = `
                        <strong>${timeAgo}</strong> -
                        目标MAC: <code>${data.lastCapture.targetMACAddress}</code> |
                        来源: <code>${data.lastCapture.sourceIPAddress}</code> |
                        匹配设备: ${deviceInfo}
                    `;
                } else {
                    document.getElementById('lastCaptureInfo').textContent = '暂无捕获记录';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                showError('加载统计信息失败: ' + error.message);
            }
        }

        // 加载捕获记录
        async function loadCaptures(page = 1) {
            try {
                const response = await fetch(`/api/MagicPackets?page=${page}&pageSize=${pageSize}`);
                if (!response.ok) throw new Error('Failed to load captures');

                const result = await response.json();

                console.log('Magic Packets API response:', result); // 调试信息

                // 处理 ReferenceHandler.Preserve 格式 (data.$values)
                let capturesData = [];
                if (result && result.data) {
                    if (typeof result.data === 'object' && '$values' in result.data) {
                        capturesData = Array.isArray(result.data.$values) ? result.data.$values : [];
                    } else if (Array.isArray(result.data)) {
                        capturesData = result.data;
                    }
                }

                renderCapturesTable(capturesData);
                renderPagination(result.total || 0, page, result.pageSize || pageSize);

                currentPage = page;

                // 更新最后刷新时间
                document.getElementById('lastRefreshTime').textContent =
                    `最后刷新: ${new Date().toLocaleTimeString()}`;

                // 更新状态指示器
                document.getElementById('statusIndicator').className = 'status-indicator active';
                document.getElementById('statusText').textContent = '监听中...';
            } catch (error) {
                console.error('Error loading captures:', error);
                document.getElementById('statusIndicator').className = 'status-indicator inactive';
                document.getElementById('statusText').textContent = '连接失败';
                showError('加载捕获记录失败: ' + error.message);
            }
        }

        // 渲染捕获记录表格
        function renderCapturesTable(captures) {
            const tbody = document.getElementById('capturesTableBody');

            if (!captures || captures.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-data">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <p class="mt-2">暂无捕获记录</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = captures.map(capture => {
                const capturedAt = new Date(capture.capturedAt);
                const isNew = lastCapturedAt && capturedAt > lastCapturedAt;
                const statusBadge = capture.isValid
                    ? '<span class="badge valid-badge">有效</span>'
                    : '<span class="badge invalid-badge">无效</span>';
                const deviceInfo = capture.matchedDeviceName
                    ? `<a href="/index.html">${capture.matchedDeviceName}</a><br><small class="text-muted">${capture.matchedDeviceIP || ''}</small>`
                    : '<span class="text-muted">未匹配</span>';

                return `
                    <tr class="${isNew ? 'new-record' : ''}">
                        <td>${formatDateTime(capturedAt)}<br><small class="text-muted">${getTimeAgo(capturedAt)}</small></td>
                        <td><code>${capture.targetMACAddress}</code></td>
                        <td><code>${capture.sourceIPAddress}</code></td>
                        <td>${deviceInfo}</td>
                        <td>${capture.packetSize} 字节</td>
                        <td>${statusBadge}</td>
                        <td>${capture.notes || '-'}</td>
                    </tr>
                `;
            }).join('');

            // 更新最后捕获时间
            if (captures.length > 0) {
                lastCapturedAt = new Date(captures[0].capturedAt);
            }
        }

        // 渲染分页
        function renderPagination(total, currentPage, pageSize) {
            const totalPages = Math.ceil(total / pageSize);
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadCaptures(${currentPage - 1}); return false;">上一页</a>
                </li>
            `;

            // 显示页码（最多显示7个）
            let startPage = Math.max(1, currentPage - 3);
            let endPage = Math.min(totalPages, currentPage + 3);

            if (startPage > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadCaptures(1); return false;">1</a></li>`;
                if (startPage > 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadCaptures(${i}); return false;">${i}</a>
                    </li>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadCaptures(${totalPages}); return false;">${totalPages}</a></li>`;
            }

            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadCaptures(${currentPage + 1}); return false;">下一页</a>
                </li>
            `;

            pagination.innerHTML = html;
        }

        // 刷新数据
        function refreshData() {
            loadStats();
            loadCaptures(currentPage);
        }

        // 切换自动刷新
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;

            const icon = document.getElementById('autoRefreshIcon');
            const text = document.getElementById('autoRefreshText');

            if (autoRefreshEnabled) {
                icon.className = 'bi bi-pause-fill';
                text.textContent = '停止自动刷新';

                // 每5秒刷新一次
                autoRefreshInterval = setInterval(() => {
                    refreshData();
                }, 5000);
            } else {
                icon.className = 'bi bi-play-fill';
                text.textContent = '启用自动刷新';

                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        // 格式化日期时间
        function formatDateTime(date) {
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 获取相对时间
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return `${seconds} 秒前`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} 分钟前`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} 小时前`;
            const days = Math.floor(hours / 24);
            return `${days} 天前`;
        }

        // 显示错误消息
        function showError(message) {
            alert(message);
        }
    </script>
</body>
</html>
